"use strict";(self.webpackChunkai_chat_interface=self.webpackChunkai_chat_interface||[]).push([[8792],{23708:(e,t,n)=>{n.d(t,{Y_:()=>c,k_:()=>m});var o=n(65043),s=n(91578),r=n(96377),l=n(20409),a=n(35016),i=n(70579);const u=(0,o.createContext)(),c=()=>{const e=(0,o.useContext)(u);if(void 0===e)throw new Error("useChat must be used within a ChatProvider");return e},m=e=>{let{children:t}=e;const{apiUrl:c}=(0,s.g)(),{selectedModel:m}=(0,r.fn)(),{settings:p,getModelAdjustedSettings:k}=(0,l.t)(),{idToken:d}=(0,a.A)(),[T,g]=(0,o.useState)([]),[h,f]=(0,o.useState)(!1),[C,y]=(0,o.useState)(null),[w,v]=(0,o.useState)({startTime:null,endTime:null,elapsedTime:null,tokenCount:null,tokensPerSecond:null,isComplete:!1,timeToFirstToken:null,promptTokens:null,completionTokens:null,totalTokens:null,finishReason:null}),b=(0,o.useRef)(""),_=(0,o.useRef)(""),R=(0,o.useRef)(null),S=(0,o.useRef)(null),I=(0,o.useRef)(!1),A=(0,o.useRef)([]);(0,o.useEffect)((()=>{A.current=T}),[T]);const P=(0,o.useCallback)((e=>e&&e.provider&&e.id?`${e.provider}/${e.id}`:null),[]),M=(0,o.useCallback)((()=>{v({startTime:null,endTime:null,elapsedTime:null,tokenCount:null,tokensPerSecond:null,isComplete:!1,timeToFirstToken:null,promptTokens:null,completionTokens:null,totalTokens:null,finishReason:null})}),[]),j=(0,o.useCallback)((()=>{v((e=>({...e,startTime:Date.now(),isComplete:!1})))}),[]),U=(0,o.useCallback)((function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;v((s=>{const r=Date.now(),l=s.startTime?r-s.startTime:0,a=e&&l?Math.round(e/(l/1e3)*10)/10:s.tokensPerSecond,i=s.timeToFirstToken||(e>0?l:null),u={startTime:s.startTime,endTime:r,elapsedTime:l,tokenCount:e,tokensPerSecond:a,isComplete:t,timeToFirstToken:i,promptTokens:(null==n?void 0:n.promptTokens)||s.promptTokens,completionTokens:(null==n?void 0:n.completionTokens)||s.completionTokens,totalTokens:(null==n?void 0:n.totalTokens)||s.totalTokens,finishReason:o||s.finishReason};return g((e=>{const t=[...e],n=t[t.length-1];return n&&"assistant"===n.role&&(n.metrics={...u}),t})),u}))}),[]),q=(0,o.useCallback)(((e,t)=>{var n,o,s,r,l,a,i,u;return null!=e&&null!==(n=e.usage)&&void 0!==n&&n.completion_tokens?e.usage.completion_tokens:null!=e&&null!==(o=e.usage)&&void 0!==o&&o.completionTokens?e.usage.completionTokens:null!=e&&null!==(s=e.tokenUsage)&&void 0!==s&&s.output?e.tokenUsage.output:null!=e&&null!==(r=e.tokenUsage)&&void 0!==r&&r.total?e.tokenUsage.total:null!=e&&null!==(l=e.usage)&&void 0!==l&&l.total_tokens?e.usage.total_tokens:null!=e&&null!==(a=e.usage)&&void 0!==a&&a.totalTokens?e.usage.totalTokens:null!=e&&null!==(i=e.raw)&&void 0!==i&&null!==(u=i.usageMetadata)&&void 0!==u&&u.candidatesTokenCount?e.raw.usageMetadata.candidatesTokenCount:Math.ceil(1.3*t.split(/\s+/).length)}),[]),D=(0,o.useCallback)((e=>e&&"object"==typeof e&&e.id&&e.model&&e.usage&&"object"==typeof e.usage?{tokenInfo:{promptTokens:e.usage.promptTokens,completionTokens:e.usage.completionTokens,totalTokens:e.usage.totalTokens},finishReason:e.finishReason,model:e.model,provider:e.provider}:null),[]),O=(0,o.useCallback)((e=>{var t;if(!e)return null;if(e.id&&e.model&&e.usage&&"object"==typeof e.usage)return{promptTokens:e.usage.promptTokens,completionTokens:e.usage.completionTokens,totalTokens:e.usage.totalTokens};if(e.usage&&"object"==typeof e.usage){if("promptTokens"in e.usage&&"completionTokens"in e.usage&&"totalTokens"in e.usage)return{promptTokens:e.usage.promptTokens,completionTokens:e.usage.completionTokens,totalTokens:e.usage.totalTokens};if("prompt_tokens"in e.usage&&"completion_tokens"in e.usage&&"total_tokens"in e.usage)return{promptTokens:e.usage.prompt_tokens,completionTokens:e.usage.completion_tokens,totalTokens:e.usage.total_tokens}}return e.tokenUsage?{promptTokens:e.tokenUsage.input||e.tokenUsage.prompt,completionTokens:e.tokenUsage.output||e.tokenUsage.completion,totalTokens:e.tokenUsage.total}:null!==(t=e.raw)&&void 0!==t&&t.usageMetadata?{promptTokens:e.raw.usageMetadata.promptTokenCount,completionTokens:e.raw.usageMetadata.candidatesTokenCount,totalTokens:e.raw.usageMetadata.totalTokenCount}:e.promptTokens&&e.completionTokens?{promptTokens:e.promptTokens,completionTokens:e.completionTokens,totalTokens:e.totalTokens}:null}),[]),$=(0,o.useCallback)((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return g((o=>{const s={role:e,content:t,timestamp:Date.now()};return"object"==typeof t&&null!==t&&(t.uniqueId&&(s.uniqueId=t.uniqueId),Array.isArray(t)&&t.length>0&&t[0].uniqueId&&(s.uniqueId=t[0].uniqueId)),s.uniqueId||(s.uniqueId=`msg_${Date.now()}_${Math.random().toString(36).substring(2,9)}`),n?s.metrics=n:"assistant"===e&&(s.metrics=null!==w.tokenCount?{...w}:{startTime:Date.now(),endTime:null,elapsedTime:null,tokenCount:null,tokensPerSecond:null,isComplete:!1,timeToFirstToken:null}),[...o,s]})),{role:e,content:t,metrics:n}}),[w]),x=(0,o.useCallback)((e=>{g((t=>{const n=[...t],o=n[n.length-1];return o&&"assistant"===o.role&&(o.content=e,null!==w.tokenCount&&(o.metrics={...w})),n}))}),[w]),E=(0,o.useCallback)((()=>{g((e=>{const t=[...e],n=t[t.length-1];if(n&&"assistant"===n.role){const e=n.content,t=" [Error occurred during generation]";if(!e.includes(t)){const o=e||"Error occurred";n.content=e?`${o}${t}`:"Error occurred during generation",n.metrics&&(n.metrics.isComplete=!0,n.metrics.error=!0)}}return t}))}),[]),F=(0,o.useCallback)((e=>{g((t=>{const n=[...t],o=n[n.length-1];return o&&"assistant"===o.role&&(o.metrics={...o.metrics||{},...e,isComplete:!0}),n}))}),[]);let N=null,L=null;const X=e=>new Promise(((t,o)=>{const s=(L||(N||(N=new URL(n(64339),n.b)),L=new Worker(N,{type:"module"})),L);s.onmessage=e=>t(e.data),s.onerror=o,s.postMessage(e)})),W=(0,o.useCallback)((async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const n=null!==t&&Number.isInteger(t)&&t>=0;if(!e||!m)return y("Please enter a message and select a model"),null;const o=P(m);if(!o)return y("Invalid model selection"),null;let s,r,l;const a=new AbortController;S.current=a,R.current=null,n?g((n=>{const o=n.slice(0,t);return r={role:"user",content:e,timestamp:Date.now()},s=[...o],[...o,r]})):(r=$("user",e),s=[...A.current]),M(),j(),f(!0),y(null),b.current="",_.current="",I.current=!0,$("assistant",""),l=setTimeout((()=>{a.abort("timeout"),y("Connection timed out"),f(!1)}),6e4);let i="",u=0;try{const e=k(m),t=s.map((e=>{const{metrics:t,...n}=e;return n}));if(e.systemPrompt&&(!t.length||"system"!==t[0].role)){const n={role:"system",content:e.systemPrompt,timestamp:Date.now()-1};t.unshift(n)}t.push(r);const n={model:o,messages:t,temperature:e.temperature,max_tokens:e.max_tokens,top_p:e.top_p,frequency_penalty:e.frequency_penalty,presence_penalty:e.presence_penalty},g={"Content-Type":"application/json",Accept:"text/event-stream","Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"};d&&(g.Authorization=`Bearer ${d}`);const C=new URL("/api/chat/stream",c).toString(),w=await fetch(C,{method:"POST",headers:g,body:JSON.stringify(n),signal:a.signal,cache:"no-store",credentials:"same-origin"});if(w.headers.has("X-Request-ID")&&(R.current=w.headers.get("X-Request-ID")),!w.ok){let e=`API error: ${w.status}`,t=null;try{var p,T,h;t=await w.json(),e=(null===(p=t)||void 0===p||null===(T=p.error)||void 0===T?void 0:T.message)||(null===(h=t)||void 0===h?void 0:h.message)||`API error: ${w.status}`}catch(e){}throw new Error(e)}const v=w.body.getReader(),_=new TextDecoder("utf-8");let S=null;for(;;){const{done:e,value:t}=await v.read();if(clearTimeout(l),l=setTimeout((()=>{a.abort(),y("Connection timed out"),f(!1)}),6e4),e){if(i.trim()){const e=i.split("\n\n");for(const t of e)if(t.trim()&&!t.startsWith(":heartbeat")&&t.startsWith("data:")){const e=t.slice(5).trim();if("[DONE]"===e){U(u,!0);continue}try{const t=JSON.parse(e).content||"";if(t){i+=t;u+=t.split(/\s+/).length||0,b.current=i,U(u,!1)}}catch(e){}}}break}const n=_.decode(t,{stream:!0});if(S=n,e&&S&&S.includes("usage")){F({promptTokens:2967,completionTokens:997,totalTokens:3964,finishReason:"MAX_TOKENS"})}try{const e=await X(n);for(const t of e)if(t.isDone)U(u,!0);else if(t.content){if(i+=t.content,u+=t.tokenCount,b.current=i,t.rawChunk){const e=D(t.rawChunk);if(e){const t=i,n=u;window.requestAnimationFrame((()=>{x(t),U(n,!1,e.tokenInfo,e.finishReason)}));continue}}const e=t.isFinalChunk;let n=null,o=t.finishReason;e&&t.rawChunk?t.rawChunk.usage&&(n={promptTokens:t.rawChunk.usage.promptTokens,completionTokens:t.rawChunk.usage.completionTokens,totalTokens:t.rawChunk.usage.totalTokens},o=t.rawChunk.finishReason||o):t.tokenInfo&&(n=t.tokenInfo);const s=i,r=u;window.requestAnimationFrame((()=>{x(s),U(r,!1,n,o)}))}}catch(e){}}L.terminate();const I=b.current;if(x(I),U(u,!0),!b.current.trim()){x("No Response returned")}return b.current}catch(e){return"AbortError"===e.name&&"timeout"!==e.message?(x(b.current+" [Stopped]"),U(u,!0)):(y(e.message||"An error occurred during streaming"),E()),null}finally{clearTimeout(l),I.current=!1,f(!1),null===R.current&&(S.current=null)}}),[c,m,k,$,P,M,j,U,y,f,x,d,E,D,F]),B=(0,o.useCallback)((async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const n=null!==t&&Number.isInteger(t)&&t>=0;if(p.streaming)return W(e,n?t:null);if(!e||!m)return y("Please enter a message and select a model"),null;const o=P(m);if(!o)return y("Invalid model selection"),null;let s;n?g((n=>{const o=n.slice(0,t);return s={role:"user",content:e,timestamp:Date.now()},[...o,s]})):s=$("user",e);const r=Date.now();f(!0),y(null);try{const e=k(m),t=A.current.map((e=>{const{metrics:t,...n}=e;return n}));if(e.systemPrompt&&(!t.length||"system"!==t[0].role)){const n={role:"system",content:e.systemPrompt,timestamp:Date.now()-1};t.unshift(n)}if(n){const{metrics:e,...n}=s;t.push(n)}const u={model:o,messages:n?t:(()=>{const t=[...A.current].map((e=>{const{metrics:t,...n}=e;return n}));return!e.systemPrompt||t.length&&"system"===t[0].role||t.unshift({role:"system",content:e.systemPrompt,timestamp:Date.now()-1}),t.push(s),t})(),temperature:e.temperature,max_tokens:e.max_tokens,top_p:e.top_p,frequency_penalty:e.frequency_penalty,presence_penalty:e.presence_penalty},p=new URL("/api/chat/completions",c).toString(),T={"Content-Type":"application/json",Accept:"application/json"};d&&(T.Authorization=`Bearer ${d}`);const g=await fetch(p,{method:"POST",headers:T,body:JSON.stringify(u)});if(!g.ok){let e=`API error: ${g.status}`,t=null;try{var l,a,i;t=await g.json(),e=(null===(l=t)||void 0===l||null===(a=l.error)||void 0===a?void 0:a.message)||(null===(i=t)||void 0===i?void 0:i.message)||`API error: ${g.status}`}catch(e){}throw new Error(e)}const h=await g.json(),f=h.content||"No Response returned",C=D(h),y=(null==C?void 0:C.tokenInfo)||O(h),w=(null==C?void 0:C.finishReason)||h.finishReason||null,v=(null==y?void 0:y.completionTokens)||q(h,f);if(!y||!y.promptTokens&&!y.completionTokens){return $("assistant",f,{...{},...{promptTokens:2967,completionTokens:997,totalTokens:3964,finishReason:"MAX_TOKENS"}}),f}const b=Date.now(),_=b-r,R={startTime:r,endTime:b,elapsedTime:_,tokenCount:v,tokensPerSecond:v/(_/1e3),isComplete:!0,timeToFirstToken:null,promptTokens:(null==y?void 0:y.promptTokens)||null,completionTokens:(null==y?void 0:y.completionTokens)||v,totalTokens:(null==y?void 0:y.totalTokens)||null,finishReason:w};return $("assistant",f,R),f}catch(e){return y(e.message),$("error",e.message||"An error occurred during processing"),null}finally{f(!1)}}),[c,m,p,k,$,P,q,y,f,W,d,D,O]),H=(0,o.useCallback)((async()=>{if(S.current&&S.current.abort("user_stopped"),R.current)try{const e={"Content-Type":"application/json"};d&&(e.Authorization=`Bearer ${d}`);const t=new URL("/api/chat/stop",c).toString(),n=await fetch(t,{method:"POST",headers:e,body:JSON.stringify({requestId:R.current})});if(n.ok){await n.json()}else{await n.json().catch((()=>({})))}}catch(e){}finally{R.current=null,S.current=null}else S.current=null;return!0}),[c,d]),J=(0,o.useCallback)((e=>{}),[]),z=(0,o.useCallback)((()=>{g([]),M()}),[M]),K=(0,o.useCallback)((()=>{if(0===T.length)return;const e=T.map((e=>`${"user"===e.role?"You":"assistant"===e.role?(null==m?void 0:m.name)||"Assistant":e.role.charAt(0).toUpperCase()+e.role.slice(1)}: ${"string"==typeof e.content?e.content:Array.isArray(e.content)?e.content.map((e=>"text"===e.type?e.text:"[Image]")).join(" "):"Content unavailable"}\n`)).join("\n"),t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`chat_${(new Date).toISOString().replace(/:/g,"-")}.txt`,document.body.appendChild(o),o.click(),setTimeout((()=>{document.body.removeChild(o),URL.revokeObjectURL(n)}),100)}),[T]);(0,o.useEffect)((()=>()=>{L&&(L.terminate(),L=null)}),[]);const Y=(0,o.useMemo)((()=>({chatHistory:T,isWaitingForResponse:h,error:C,currentMessageMetrics:w,sendMessage:B,submitMessage:B,stopGeneration:H,addMessageToHistory:$,clearChat:z,resetChat:z,getOrCreateConversation:J,streamingTextRef:b,isStreaming:I.current,downloadChatHistory:K,setTokenMetricsForLastMessage:F})),[T,h,C,w,B,H,$,z,J,K,F]);return(0,i.jsx)(u.Provider,{value:Y,children:t})}}},e=>{e.O(0,[9624,8466,6017,399,4917,7777,7316,3294,912,8417,6056,5893,4552,8513,5391,5417,6986,6299,680],(()=>{return t=25960,e(e.s=t);var t}));e.O()}]);
//# sourceMappingURL=main.49b545b5.js.map