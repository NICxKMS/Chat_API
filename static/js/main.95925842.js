"use strict";(self.webpackChunkai_chat_interface=self.webpackChunkai_chat_interface||[]).push([[8792],{23708:(e,t,n)=>{n.d(t,{Y_:()=>c,k_:()=>m});var o=n(65043),s=n(91578),r=n(96377),l=n(20409),a=n(35016),i=n(70579);const u=(0,o.createContext)(),c=()=>{const e=(0,o.useContext)(u);if(void 0===e)throw new Error("useChat must be used within a ChatProvider");return e},m=e=>{let{children:t}=e;const{apiUrl:c}=(0,s.g)(),{selectedModel:m}=(0,r.fn)(),{settings:p,getModelAdjustedSettings:k}=(0,l.t)(),{idToken:d}=(0,a.A)(),[T,g]=(0,o.useState)([]),[h,f]=(0,o.useState)(!1),[C,y]=(0,o.useState)(null),[w,v]=(0,o.useState)({startTime:null,endTime:null,elapsedTime:null,tokenCount:null,tokensPerSecond:null,isComplete:!1,timeToFirstToken:null,promptTokens:null,completionTokens:null,totalTokens:null,finishReason:null}),b=(0,o.useRef)(""),_=(0,o.useRef)(""),R=(0,o.useRef)(null),S=(0,o.useRef)(null),I=(0,o.useRef)(!1),A=(0,o.useCallback)((e=>e&&e.provider&&e.id?`${e.provider}/${e.id}`:null),[]),P=(0,o.useCallback)((()=>{v({startTime:null,endTime:null,elapsedTime:null,tokenCount:null,tokensPerSecond:null,isComplete:!1,timeToFirstToken:null,promptTokens:null,completionTokens:null,totalTokens:null,finishReason:null})}),[]),M=(0,o.useCallback)((()=>{v((e=>({...e,startTime:Date.now(),isComplete:!1})))}),[]),j=(0,o.useCallback)((function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;v((s=>{const r=Date.now(),l=s.startTime?r-s.startTime:0,a=e&&l?Math.round(e/(l/1e3)*10)/10:s.tokensPerSecond,i=s.timeToFirstToken||(e>0?l:null),u={startTime:s.startTime,endTime:r,elapsedTime:l,tokenCount:e,tokensPerSecond:a,isComplete:t,timeToFirstToken:i,promptTokens:(null==n?void 0:n.promptTokens)||s.promptTokens,completionTokens:(null==n?void 0:n.completionTokens)||s.completionTokens,totalTokens:(null==n?void 0:n.totalTokens)||s.totalTokens,finishReason:o||s.finishReason};return g((e=>{const t=[...e],n=t[t.length-1];return n&&"assistant"===n.role&&(n.metrics={...u}),t})),u}))}),[]),U=(0,o.useCallback)(((e,t)=>{var n,o,s,r,l,a,i,u;return null!=e&&null!==(n=e.usage)&&void 0!==n&&n.completion_tokens?e.usage.completion_tokens:null!=e&&null!==(o=e.usage)&&void 0!==o&&o.completionTokens?e.usage.completionTokens:null!=e&&null!==(s=e.tokenUsage)&&void 0!==s&&s.output?e.tokenUsage.output:null!=e&&null!==(r=e.tokenUsage)&&void 0!==r&&r.total?e.tokenUsage.total:null!=e&&null!==(l=e.usage)&&void 0!==l&&l.total_tokens?e.usage.total_tokens:null!=e&&null!==(a=e.usage)&&void 0!==a&&a.totalTokens?e.usage.totalTokens:null!=e&&null!==(i=e.raw)&&void 0!==i&&null!==(u=i.usageMetadata)&&void 0!==u&&u.candidatesTokenCount?e.raw.usageMetadata.candidatesTokenCount:Math.ceil(1.3*t.split(/\s+/).length)}),[]),q=(0,o.useCallback)((e=>e&&"object"==typeof e&&e.id&&e.model&&e.usage&&"object"==typeof e.usage?{tokenInfo:{promptTokens:e.usage.promptTokens,completionTokens:e.usage.completionTokens,totalTokens:e.usage.totalTokens},finishReason:e.finishReason,model:e.model,provider:e.provider}:null),[]),D=(0,o.useCallback)((e=>{var t;if(!e)return null;if(e.id&&e.model&&e.usage&&"object"==typeof e.usage)return{promptTokens:e.usage.promptTokens,completionTokens:e.usage.completionTokens,totalTokens:e.usage.totalTokens};if(e.usage&&"object"==typeof e.usage){if("promptTokens"in e.usage&&"completionTokens"in e.usage&&"totalTokens"in e.usage)return{promptTokens:e.usage.promptTokens,completionTokens:e.usage.completionTokens,totalTokens:e.usage.totalTokens};if("prompt_tokens"in e.usage&&"completion_tokens"in e.usage&&"total_tokens"in e.usage)return{promptTokens:e.usage.prompt_tokens,completionTokens:e.usage.completion_tokens,totalTokens:e.usage.total_tokens}}return e.tokenUsage?{promptTokens:e.tokenUsage.input||e.tokenUsage.prompt,completionTokens:e.tokenUsage.output||e.tokenUsage.completion,totalTokens:e.tokenUsage.total}:null!==(t=e.raw)&&void 0!==t&&t.usageMetadata?{promptTokens:e.raw.usageMetadata.promptTokenCount,completionTokens:e.raw.usageMetadata.candidatesTokenCount,totalTokens:e.raw.usageMetadata.totalTokenCount}:e.promptTokens&&e.completionTokens?{promptTokens:e.promptTokens,completionTokens:e.completionTokens,totalTokens:e.totalTokens}:null}),[]),O=(0,o.useCallback)((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return g((o=>{const s={role:e,content:t,timestamp:Date.now()};return"object"==typeof t&&null!==t&&(t.uniqueId&&(s.uniqueId=t.uniqueId),Array.isArray(t)&&t.length>0&&t[0].uniqueId&&(s.uniqueId=t[0].uniqueId)),s.uniqueId||(s.uniqueId=`msg_${Date.now()}_${Math.random().toString(36).substring(2,9)}`),n?s.metrics=n:"assistant"===e&&(s.metrics=null!==w.tokenCount?{...w}:{startTime:Date.now(),endTime:null,elapsedTime:null,tokenCount:null,tokensPerSecond:null,isComplete:!1,timeToFirstToken:null}),[...o,s]})),{role:e,content:t,metrics:n}}),[w]),$=(0,o.useCallback)((e=>{g((t=>{const n=[...t],o=n[n.length-1];return o&&"assistant"===o.role&&(o.content=e,null!==w.tokenCount&&(o.metrics={...w})),n}))}),[w]),x=(0,o.useCallback)((()=>{g((e=>{const t=[...e],n=t[t.length-1];if(n&&"assistant"===n.role){const e=n.content,t=" [Error occurred during generation]";if(!e.includes(t)){const o=e||"Error occurred";n.content=e?`${o}${t}`:"Error occurred during generation",n.metrics&&(n.metrics.isComplete=!0,n.metrics.error=!0)}}return t}))}),[]),E=(0,o.useCallback)((e=>{g((t=>{const n=[...t],o=n[n.length-1];return o&&"assistant"===o.role&&(o.metrics={...o.metrics||{},...e,isComplete:!0}),n}))}),[]),F=(0,o.useCallback)((async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(I.current)return null;const o=null!==t&&Number.isInteger(t)&&t>=0;if(!e||!m)return y("Please enter a message and select a model"),null;const s=A(m);if(!s)return y("Invalid model selection"),null;let r,l,a,i=null;const u=new AbortController;S.current=u,R.current=null,o?g((n=>{const o=n.slice(0,t);return l={role:"user",content:e,timestamp:Date.now()},r=[...o],[...o,l]})):(l=O("user",e),r=[...T]),P(),M(),f(!0),y(null),b.current="",_.current="",I.current=!0,O("assistant",""),a=setTimeout((()=>{u.abort("timeout"),y("Connection timed out"),f(!1)}),6e4);let p="",h=0;try{const e=k(m),t=r.map((e=>{const{metrics:t,...n}=e;return n}));if(e.systemPrompt&&(!t.length||"system"!==t[0].role)){const n={role:"system",content:e.systemPrompt,timestamp:Date.now()-1};t.unshift(n)}t.push(l);const o={model:s,messages:t,temperature:e.temperature,max_tokens:e.max_tokens,top_p:e.top_p,frequency_penalty:e.frequency_penalty,presence_penalty:e.presence_penalty},T={"Content-Type":"application/json",Accept:"text/event-stream","Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"};d&&(T.Authorization=`Bearer ${d}`);const g=new URL("/api/chat/stream",c).toString(),_=await fetch(g,{method:"POST",headers:T,body:JSON.stringify(o),signal:u.signal,cache:"no-store",credentials:"same-origin"});if(_.headers.has("X-Request-ID")&&(R.current=_.headers.get("X-Request-ID")),!_.ok){let e=`API error: ${_.status}`,t=null;try{var C,w,v;t=await _.json(),e=(null===(C=t)||void 0===C||null===(w=C.error)||void 0===w?void 0:w.message)||(null===(v=t)||void 0===v?void 0:v.message)||`API error: ${_.status}`}catch(e){}throw new Error(e)}const S=_.body.getReader(),I=new TextDecoder("utf-8");i=new Worker(new URL(n.p+n.u(7301),n.b),{type:void 0});const A=e=>new Promise(((t,n)=>{i?(i.onmessage=e=>t(e.data),i.onerror=n,i.postMessage(e)):n(new Error("Stream worker was terminated"))}));let P=null;try{for(;;){const{done:e,value:t}=await S.read();if(clearTimeout(a),a=setTimeout((()=>{u.abort(),y("Connection timed out"),f(!1)}),6e4),e){if(p.trim()){const e=p.split("\n\n");for(const t of e)if(t.trim()&&!t.startsWith(":heartbeat")&&t.startsWith("data:")){const e=t.slice(5).trim();if("[DONE]"===e){j(h,!0);continue}try{const t=JSON.parse(e).content||"";if(t){p+=t;h+=t.split(/\s+/).length||0,b.current=p,j(h,!1)}}catch(e){}}}break}const n=I.decode(t,{stream:!0});if(P=n,e&&P&&P.includes("usage")){E({promptTokens:2967,completionTokens:997,totalTokens:3964,finishReason:"MAX_TOKENS"})}try{const e=await A(n);for(const t of e)if(t.isDone)j(h,!0);else if(t.content){if(p+=t.content,h+=t.tokenCount,b.current=p,t.rawChunk){const e=q(t.rawChunk);if(e){const t=p,n=h;window.requestAnimationFrame((()=>{$(t),j(n,!1,e.tokenInfo,e.finishReason)}));continue}}const e=t.isFinalChunk;let n=null,o=t.finishReason;e&&t.rawChunk?t.rawChunk.usage&&(n={promptTokens:t.rawChunk.usage.promptTokens,completionTokens:t.rawChunk.usage.completionTokens,totalTokens:t.rawChunk.usage.totalTokens},o=t.rawChunk.finishReason||o):t.tokenInfo&&(n=t.tokenInfo);const s=p,r=h;window.requestAnimationFrame((()=>{$(s),j(r,!1,n,o)}))}}catch(e){}}}finally{S.releaseLock()}i&&(i.terminate(),i=null);const M=b.current;if($(M),j(h,!0),!b.current.trim()){$("No Response returned")}return b.current}catch(e){return"AbortError"===e.name&&"timeout"!==e.message?($(b.current+" [Stopped]"),j(h,!0)):(y(e.message||"An error occurred during streaming"),x()),null}finally{if(clearTimeout(a),I.current=!1,f(!1),i)try{i.terminate(),i=null}catch(e){}null===R.current&&(S.current=null)}}),[c,m,T,k,O,A,P,M,j,y,f,$,d,x,q,E]),L=(0,o.useCallback)((async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e||""===e.trim())return y("Please enter a message"),null;if(h)return null;const n=null!==t&&Number.isInteger(t)&&t>=0;if(p.streaming)return F(e,n?t:null);if(!e||!m)return y("Please enter a message and select a model"),null;const o=A(m);if(!o)return y("Invalid model selection"),null;let s;n?g((n=>{const o=n.slice(0,t);return s={role:"user",content:e,timestamp:Date.now()},[...o,s]})):s=O("user",e);const r=Date.now();f(!0),y(null);try{const e=k(m),t=T.map((e=>{const{metrics:t,...n}=e;return n}));if(e.systemPrompt&&(!t.length||"system"!==t[0].role)){const n={role:"system",content:e.systemPrompt,timestamp:Date.now()-1};t.unshift(n)}if(n){const{metrics:e,...n}=s;t.push(n)}const u={model:o,messages:n?t:(()=>{const t=[...T].map((e=>{const{metrics:t,...n}=e;return n}));return!e.systemPrompt||t.length&&"system"===t[0].role||t.unshift({role:"system",content:e.systemPrompt,timestamp:Date.now()-1}),t.push(s),t})(),temperature:e.temperature,max_tokens:e.max_tokens,top_p:e.top_p,frequency_penalty:e.frequency_penalty,presence_penalty:e.presence_penalty},p=new URL("/api/chat/completions",c).toString(),g={"Content-Type":"application/json",Accept:"application/json"};d&&(g.Authorization=`Bearer ${d}`);const h=await fetch(p,{method:"POST",headers:g,body:JSON.stringify(u)});if(!h.ok){let e=`API error: ${h.status}`,t=null;try{var l,a,i;t=await h.json(),e=(null===(l=t)||void 0===l||null===(a=l.error)||void 0===a?void 0:a.message)||(null===(i=t)||void 0===i?void 0:i.message)||`API error: ${h.status}`}catch(e){}throw new Error(e)}const f=await h.json(),C=f.content||"No Response returned",y=q(f),w=(null==y?void 0:y.tokenInfo)||D(f),v=(null==y?void 0:y.finishReason)||f.finishReason||null,b=(null==w?void 0:w.completionTokens)||U(f,C);if(!w||!w.promptTokens&&!w.completionTokens){return O("assistant",C,{...{},...{promptTokens:2967,completionTokens:997,totalTokens:3964,finishReason:"MAX_TOKENS"}}),C}const _=Date.now(),R=_-r,S={startTime:r,endTime:_,elapsedTime:R,tokenCount:b,tokensPerSecond:b/(R/1e3),isComplete:!0,timeToFirstToken:null,promptTokens:(null==w?void 0:w.promptTokens)||null,completionTokens:(null==w?void 0:w.completionTokens)||b,totalTokens:(null==w?void 0:w.totalTokens)||null,finishReason:v};return O("assistant",C,S),C}catch(e){return y(e.message),O("error",e.message||"An error occurred during processing"),null}finally{f(!1)}}),[c,m,T,p,k,O,A,U,y,f,F,d,q,D]),N=(0,o.useCallback)((async()=>{if(S.current&&S.current.abort("user_stopped"),R.current)try{const e={"Content-Type":"application/json"};d&&(e.Authorization=`Bearer ${d}`);const t=new URL("/api/chat/stop",c).toString(),n=await fetch(t,{method:"POST",headers:e,body:JSON.stringify({requestId:R.current})});if(n.ok){await n.json()}else{await n.json().catch((()=>({})))}}catch(e){}finally{R.current=null,S.current=null}else S.current=null;return!0}),[c,d]),X=(0,o.useCallback)((e=>{}),[]),W=(0,o.useCallback)((()=>{g([]),P()}),[P]),B=(0,o.useCallback)((()=>{if(0===T.length)return;const e=T.map((e=>`${"user"===e.role?"You":"assistant"===e.role?(null==m?void 0:m.name)||"Assistant":e.role.charAt(0).toUpperCase()+e.role.slice(1)}: ${"string"==typeof e.content?e.content:Array.isArray(e.content)?e.content.map((e=>"text"===e.type?e.text:"[Image]")).join(" "):"Content unavailable"}\n`)).join("\n"),t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`chat_${(new Date).toISOString().replace(/:/g,"-")}.txt`,document.body.appendChild(o),o.click(),setTimeout((()=>{document.body.removeChild(o),URL.revokeObjectURL(n)}),100)}),[T,null==m?void 0:m.name]),H=(0,o.useMemo)((()=>({chatHistory:T,isWaitingForResponse:h,error:C,currentMessageMetrics:w,sendMessage:L,submitMessage:L,stopGeneration:N,addMessageToHistory:O,clearChat:W,resetChat:W,getOrCreateConversation:X,streamingTextRef:b,isStreaming:I.current,downloadChatHistory:B,setTokenMetricsForLastMessage:E})),[T,h,C,w,L,N,O,W,X,B,E]);return(0,i.jsx)(u.Provider,{value:H,children:t})}}},e=>{e.O(0,[9624,8466,6017,399,4917,7777,7316,3294,912,8417,6056,9469,8896,652,8513,5391,5417,6986,4833,8447],(()=>{return t=72812,e(e.s=t);var t}));e.O()}]);
//# sourceMappingURL=main.95925842.js.map